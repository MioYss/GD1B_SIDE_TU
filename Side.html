<!doctype html>

<html lang="en">

<head>

<meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>

<script

    src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

<style type="text/css"> body { margin: 0; }</style>

</head>

<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1600, height: 1600,
    physics: {
    default: 'arcade',
    arcade: {
        gravity: { y: 300 },
        debug: false
    }},
    scene: {preload: preload, create: create, update: update }
};

new Phaser.Game(config);


//---------------------------------------------------------------------------------------
//---------------------------------FONCTION PRELOAD---------------------------------------
//---------------------------------------------------------------------------------------
function preload(){
    // chargement tuiles de jeu
    this.load.image("Phaser_tuiles_jeu", "assets/tuiles_jeu.png");

    // chargement de la carte
    this.load.tilemapTiledJSON("carte", "assets/map.json");

    this.load.spritesheet('perso','assets/perso.png',
        { frameWidth: 32, frameHeight: 48 });
}
var platforms;
var player;
var cursors;

//---------------------------------------------------------------------------------------
//---------------------------------FONCTION CREATE---------------------------------------
//---------------------------------------------------------------------------------------
function create(){
    console.log(this)
    // chargement de la carte
    const carteDuNiveau = this.add.tilemap("carte");

    // chargement du jeu de tuiles
    const tileset = carteDuNiveau.addTilesetImage(
      "Final 04",
      "Phaser_tuiles_jeu"
    );

    // chargement du calque background_02 (les élements qui passent devant le joueur)
    const background_02 = carteDuNiveau.createLayer(
        "background_02",
        tileset
        );

    // chargement du calque background_03
    const background_03 = carteDuNiveau.createLayer(
        "background_03",
        tileset
    ); 

    // chargement du calque background_01
    const background_01 = carteDuNiveau.createLayer(
        "background_01",
        tileset
    ); 

    // chargement du calque background_principal_01 (platfromes)
    const background_principal_01 = carteDuNiveau.createLayer(
        "background_principal_01",
        tileset
    );

    player = this.physics.add.sprite(100, 450, 'perso'); // La 1ère ligne permet de générer le sprite du personnage à partir de la spritesheet. La 2nde définit un rebond lors du contact avec le sol. La 3e et la 4e permettent au personnage de collisionner respectivement avec les bords du niveau et avec les plateformes..

    player.setBounce(0.2);
    player.setCollideWorldBounds(true);

    this.anims.create({                             //Les 3 autres instructions correspondent à des créations d’animations : aller vers la gauche, faire face à la caméra, aller vers la droite. On peut remarquer au passage qu’une animation consiste en un nombre de frames que Phaser va pouvoir découper automatiquement dans la spritesheet, en fonction de la taille définie lors du préchargement de l’asset.
        key: 'left',
        frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'perso', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
        frameRate: 10,
    repeat: -1
    });

    cursors = this.input.keyboard.createCursorKeys(); // permet, lors de la mise en place du jeu, de générer la prise en charge des touches directionnelles du clavier.


    // définition des tuiles de plateformes qui sont solides
    // utilisation de la propriété estSolide
    background_principal_01.setCollisionByProperty({ estSolide: true }); 

    // ajout d'une collision entre le joueur et le calque plateformes
    this.physics.add.collider(player, plateforms); 


    // redimentionnement du monde avec les dimensions calculées via tiled
    this.physics.world.setBounds(0, 0, 3200, 640);
    
    //  ajout du champs de la caméra de taille identique à celle du monde
    this.cameras.main.setBounds(0, 0, 3200, 640);
    
    // ancrage de la caméra sur le joueur
    this.cameras.main.startFollow(player); 

    if (clavier.up.isDown && player.body.blocked.down) {
          player.setVelocityY(-200);
    }  

}


//---------------------------------------------------------------------------------------
//---------------------------------FONCTION UPDATE---------------------------------------
//---------------------------------------------------------------------------------------
function update(){

    if (cursors.left.isDown){ //si la touche gauche est appuyée
        player.setVelocityX(-160); //alors vitesse négative en X
        player.anims.play('left', true); //et animation => gauche
    }

    else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
        player.setVelocityX(160); //alors vitesse positive en X
        player.anims.play('right', true); //et animation => droite
    }

    else{ // sinon
        player.setVelocityX(0); //vitesse nulle
        player.anims.play('turn'); //animation fait face caméra
    }

    if (cursors.up.isDown && player.body.touching.down){ //si touche haut appuyée ET que le perso touche le sol
        player.setVelocityY(-330); //alors vitesse verticale négative //(on saute)
    }

}

</script>

</body>

</html>